name: Ultra Advanced Website Health Monitor

on:
  schedule:
    - cron: "*/1 * * * *"      # Run every 1 minute
  workflow_dispatch:           # Manual trigger
  push:
    paths:
      - ".github/workflows/*.yml"

jobs:
  health-check:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        target:
          - name: Main Site
            url: "https://thriiievents.com"
          - name: API
            url: "https://thriiievents.com"
          - name: IPv4
            url: "https://thriiievents.com"
            ip: "-4"
          - name: IPv6
            url: "https://thriiievents.com"
            ip: "-6"

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 1. DNS Lookup Validation
      # ----------------------------------------------------
      - name: DNS Lookup for ${{ matrix.target.name }}
        run: |
          echo "üîç DNS Lookup for: ${{ matrix.target.url }}"
          dig +short ${{ matrix.target.url }} || echo "DNS lookup failed"

      # ----------------------------------------------------
      # 2. Send HTTP Request with Retries + Timing
      # ----------------------------------------------------
      - name: Advanced Ping ${{ matrix.target.name }}
        id: ping
        run: |
          URL="${{ matrix.target.url }}"
          IP_MODE="${{ matrix.target.ip }}"
          MAX_RETRIES=5
          RETRY_DELAY=2
          ATTEMPT=1
          LOG_FILE="health_${{ matrix.target.name }}.log"

          echo "üöÄ Checking $URL (${{ matrix.target.name }})" | tee $LOG_FILE

          while [ $ATTEMPT -le $MAX_RETRIES ]
          do
            echo "Attempt #$ATTEMPT" | tee -a $LOG_FILE
            START=$(date +%s%3N)

            RESPONSE=$(curl -I -L $IP_MODE -o /dev/null -s -w "%{http_code} %{time_total}" $URL || echo "000 0")
            CODE=$(echo $RESPONSE | cut -d " " -f1)
            TIME=$(echo $RESPONSE | cut -d " " -f2)

            END=$(date +%s%3N)
            DIFF=$((END-START))

            echo "Status Code: $CODE" | tee -a $LOG_FILE
            echo "Response Time: ${TIME}s (${DIFF}ms)" | tee -a $LOG_FILE

            if [ "$CODE" -ge 200 ] && [ "$CODE" -lt 400 ]; then
              echo "‚úÖ SUCCESS" | tee -a $LOG_FILE
              echo "::set-output name=success::true"
              exit 0
            fi

            echo "‚ùå FAILURE ‚Äî retry in ${RETRY_DELAY}s" | tee -a $LOG_FILE

            sleep $RETRY_DELAY
            ATTEMPT=$((ATTEMPT+1))
            RETRY_DELAY=$((RETRY_DELAY*2))
          done

          echo "::set-output name=success::false"
          exit 1

      # ----------------------------------------------------
      # 3. Upload Logs
      # ----------------------------------------------------
      - name: Upload Health Check Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "health-logs-${{ matrix.target.name }}"
          path: "*.log"

  # --------------------------------------------------------
  # 4. Alerting Job (Runs Only on Failure)
  # --------------------------------------------------------
  alerts:
    needs: health-check
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Send Discord/Slack/Webhook Alert
        run: |
          if [ -z "$WEBHOOK_URL" ]; then
            echo "No webhook URL configured. Skipping alerts."
            exit 0
          fi

          PAYLOAD=$(cat <<EOF
          {
            "content": "üö® *WEBSITE DOWN*\nTarget: \`${{ matrix.target.url }}\`\nTime: $(date -u)"
          }
          EOF
          )

          curl -X POST -H "Content-Type: application/json" \
            -d "$PAYLOAD" $WEBHOOK_URL

        env:
          WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK }}
